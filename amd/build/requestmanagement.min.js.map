{"version":3,"file":"requestmanagement.min.js","sources":["../src/requestmanagement.js"],"sourcesContent":["/**\n * @module    mod_certifygen\n * @copyright  2024 Proyecto UNIMOODLE\n * @author     UNIMOODLE Group (Coordinator) <direccion.area.estrategia.digital@uva.es>\n * @author     3IPUNT <contacte@tresipunt.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\"use strict\";\n\nimport jQuery from 'jquery';\nimport {get_string as getString, get_strings as getStrings} from 'core/str';\nimport Ajax from 'core/ajax';\nimport Templates from 'core/templates';\nimport ModalFactory from 'core/modal_factory';\nimport ModalEvents from 'core/modal_events';\nimport Notification from 'core/notification';\nimport ModalForm from 'core_form/modalform';\n\nlet REGION = {\n    ROOT: '[data-region=\"profile-my-certificates\"]',\n};\nlet TEMPLATES = {\n    LOADING: 'core/overlay_loading',\n    TEACHER_REQUEST: 'mod_certifygen/profile_my_certificates',\n    COURSE_LIST_REQUEST: 'mod_certifygen/course_list_request',\n    // STUDENTS_TABLE: 'mod_certifygen/my_certificates_validator',\n};\nlet ACTION = {\n    CREATE_REQUEST: '[data-action=\"create-request\"]',\n    DELETE_REQUEST: '[data-action=\"delete-request\"]',\n    SEE_COURSES: '[data-action=\"see-courses\"]',\n    EMIT: '[data-action=\"emit\"]',\n    // EMIT_CERTIFICATE: '[data-action=\"emit-certificate\"]',\n    // REVOKE_CERTIFICATE: '[data-action=\"revoke-certificate\"]',\n};\nlet SERVICES = {\n    GET_TEACHER_REQUEST_VIEW_DATA: 'mod_certifygen_getteacherrequestviewdata',\n    DELETE_TEACHER_REQUEST: 'mod_certifygen_deleteteacherrequest',\n    GET_COURSES_NAMES: 'mod_certifygen_getcoursesnames',\n    EMIT_TEACHER_REQUEST: 'mod_certifygen_emitteacherrequest',\n    // EMIT_CERTIFICATE: 'mod_certifygen_emitcertificate',\n    // MYSTUDENTS_TABLE_DATA: 'mod_certifygen_get_students_certificates_table',\n    // GET_MYCERTIFICATE_TABLE_DATA: 'mod_certifygen_getmycertificatedata',\n    // REVOKE_CERTIFICATE: 'mod_certifygen_revokecertificate',\n};\nconst requestManagement = () => {\n    jQuery(ACTION.CREATE_REQUEST).on('click', createRequest);\n    jQuery(ACTION.DELETE_REQUEST).on('click', deleteRequest);\n    jQuery(ACTION.SEE_COURSES).on('click', seeCourses);\n    jQuery(ACTION.EMIT).on('click', emitCertificate);\n    // jQuery(ACTION.REVOKE_CERTIFICATE).on('click', revokeCertificate);\n};\nconst emitCertificate = async (event) => {\n    let id = event.currentTarget.getAttribute('data-id');\n    id = parseInt(id);\n    let userid = event.currentTarget.getAttribute('data-userid');\n    const stringkeys = [\n        {key: 'emitrequesttitle', component: 'mod_certifygen'},\n        {key: 'emitrequestbody', component: 'mod_certifygen', param: id},\n        {key: 'confirm', component: 'mod_certifygen'},\n        {key: 'errortitle', component: 'mod_certifygen'},\n    ];\n    getStrings(stringkeys).then((langStrings) => {\n        return ModalFactory.create({\n            title: langStrings[0],\n            body: langStrings[1],\n            type: ModalFactory.types.SAVE_CANCEL\n        }).then(modal => {\n            modal.getRoot().on(ModalEvents.hidden, () => {\n                modal.destroy();\n            });\n            modal.getRoot().on(ModalEvents.save, () => {\n                let request = {\n                    methodname: SERVICES.EMIT_TEACHER_REQUEST,\n                    args: {id}\n                };\n                Ajax.call([request])[0].done(function(response) {\n                    if (response.result == 1) {\n                        // Recargar tabla.\n                        reloadTeacherRequestTable(userid);\n                    } else {\n                        // Mostrar mensaje error.\n                        return ModalFactory.create({\n                            title: langStrings[0],\n                            body: response.message,\n                            type: ModalFactory.types.CANCEL\n                        }).then(modal => {\n                            modal.getRoot().on(ModalEvents.hidden, () => {\n                                modal.destroy();\n                            });\n                        });\n                    }\n                }).fail(Notification.exception);\n            });\n            return modal;\n        });\n    }).done(function(modal) {\n        modal.show();\n    }).fail(Notification.exception);\n};\nconst seeCourses = async (event) => {\n    let id = event.currentTarget.getAttribute('data-id');\n    let coursesids = event.currentTarget.getAttribute('data-courses');\n    const stringkeys = [\n        {key: 'seecoursestitle', component: 'mod_certifygen', param: id},\n    ];\n    let langStrings = await getStrings(stringkeys);\n    let request = {\n        methodname: SERVICES.GET_COURSES_NAMES,\n        args: {coursesids}\n    };\n    let coursesdata = await Ajax.call([request])[0];\n    let courseshtml = await Templates.render(TEMPLATES.COURSE_LIST_REQUEST, coursesdata).done(function(html) {\n        return html;\n    });\n    await ModalFactory.create({\n            title: langStrings[0],\n            body: courseshtml,\n            type: ModalFactory.types.DEFAULT,\n        }).then(modal => {\n            modal.show();\n            modal.getRoot().on(ModalEvents.hidden, () => {\n                modal.destroy();\n            });\n        });\n};\nconst deleteRequest = (event) => {\n    let id = event.currentTarget.getAttribute('data-id');\n    const stringkeys = [\n        {key: 'deleterequesttitle', component: 'mod_certifygen'},\n        {key: 'deleterequestbody', component: 'mod_certifygen', param: id},\n        {key: 'confirm', component: 'mod_certifygen'},\n        {key: 'errortitle', component: 'mod_certifygen'},\n    ];\n    getStrings(stringkeys).then((langStrings) => {\n        return ModalFactory.create({\n            title: langStrings[0],\n            body: langStrings[1],\n            type: ModalFactory.types.SAVE_CANCEL\n        }).then(modal => {\n            modal.getRoot().on(ModalEvents.hidden, () => {\n                modal.destroy();\n            });\n            modal.getRoot().on(ModalEvents.save, () => {\n                let request = {\n                    methodname: SERVICES.DELETE_TEACHER_REQUEST,\n                    args: { id}\n                };\n                Ajax.call([request])[0].done(function(response) {\n                    if (response.result == 1) {\n                        // Remove tr.\n                        jQuery(event.currentTarget).parent().parent().remove();\n                    } else {\n                        // Mostrar mensaje error.\n                        return ModalFactory.create({\n                            title: langStrings[0],\n                            body: response.message,\n                            type: ModalFactory.types.CANCEL\n                        }).then(modal => {\n                            modal.getRoot().on(ModalEvents.hidden, () => {\n                                modal.destroy();\n                            });\n                        });\n                    }\n                }).fail(Notification.exception);\n            });\n            return modal;\n        });\n    }).done(function(modal) {\n        modal.show();\n    }).fail(Notification.exception);\n};\nconst createRequest = (e) => {\n    e.preventDefault();\n    const element = e.target;\n    let id = event.currentTarget.getAttribute('data-id');\n    let userid = event.currentTarget.getAttribute('data-userid');\n\n    const modalForm = new ModalForm({\n        // Name of the class where form is defined (must extend \\core_form\\dynamic_form):\n        formClass: \"mod_certifygen\\\\forms\\\\teacherrequestform\",\n        // Add as many arguments as you need, they will be passed to the form:\n        args: {id, userid},\n        // Pass any configuration settings to the modal dialogue, for example, the title:\n        modalConfig: {title: getString('create_request', 'mod_certifygen')},\n        // DOM element that should get the focus after the modal dialogue is closed:\n        returnFocus: element,\n    });\n    // Listen to events if you want to execute something on form submit. Event detail will contain everything the process()\n    // function returned:\n    modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, () => {\n        // Recargar la tabla.\n        setTimeout(reloadTeacherRequestTable(userid), 1000);\n\n    });\n    // Show the form.\n    modalForm.show();\n};\nconst reloadTeacherRequestTable = (userid) => {\n    Templates.render(TEMPLATES.LOADING, {visible: true}).done(function(html) {\n        let identifier = jQuery(REGION.ROOT);\n        identifier.append(html);\n        let request = {\n            methodname: SERVICES.GET_TEACHER_REQUEST_VIEW_DATA,\n            args: {userid}\n        };\n        Ajax.call([request])[0].done(function(data) {\n            Templates.render(TEMPLATES.TEACHER_REQUEST, data).then((html, js) => {\n                identifier.html(html);\n                Templates.runTemplateJS(js);\n            }).fail(Notification.exception);\n        }).fail(Notification.exception);\n    });\n};\n\n// const revokeCertificate = async(event) => {\n//     let issueid = event.currentTarget.getAttribute('data-issueid');\n//     let cmid = event.currentTarget.getAttribute('data-cmid');\n//     let userid = event.currentTarget.getAttribute('data-userid');\n//     let modelid = event.currentTarget.getAttribute('data-modelid');\n//     let courseid = event.currentTarget.getAttribute('data-courseid');\n//     let username = event.currentTarget.getAttribute('data-username');\n//     // Modal estas seguro que quieres eliminar el certiifcado?.\n//     const stringkeys = [\n//         {key: 'revokecertificate_title', component: 'mod_certifygen'},\n//         {key: 'revokecertificate_body', component: 'mod_certifygen', param: username},\n//         {key: 'confirm', component: 'mod_certifygen'},\n//         {key: 'revokecertificate_error', component: 'mod_certifygen'}\n//     ];\n//     let langStrings = await getStrings(stringkeys);\n//\n//     let modal = await ModalFactory.create({\n//         title: langStrings[0],\n//         body: langStrings[1],\n//         type: ModalFactory.types.SAVE_CANCEL\n//     });\n//     modal.setSaveButtonText(langStrings[2]);\n//     modal.getRoot().on(ModalEvents.save, () => {\n//         let request = {\n//             methodname: SERVICES.REVOKE_CERTIFICATE,\n//             args: {\n//                 issueid,\n//                 userid,\n//                 modelid,\n//             }\n//         };\n//         modal.destroy();\n//         Ajax.call([request])[0].done(function(response) {\n//             if (response.result === true) {\n//                 teacherReloadTable(modelid, courseid, cmid);\n//             } else {\n//                 Notification.alert('Error', response.message, langStrings[2]);\n//             }\n//         }).fail(Notification.exception);\n//     });\n//     modal.getRoot().on(ModalEvents.hidden, () => {\n//         modal.destroy();\n//     });\n//     modal.show();\n// };\n// const emitCertificate = async(event) => {\n//     let id = parseInt(event.currentTarget.getAttribute('data-id'));\n//     let modelid = parseInt(event.currentTarget.getAttribute('data-modelid'));\n//     let lang = event.currentTarget.getAttribute('data-lang');\n//     let langstring = event.currentTarget.getAttribute('data-langstring');\n//     let userid = parseInt(event.currentTarget.getAttribute('data-userid'));\n//     let courseid = parseInt(event.currentTarget.getAttribute('data-courseid'));\n//     let cmid = parseInt(event.currentTarget.getAttribute('data-cmid'));\n//\n//     // Modal estas seguro que quieres enviar el certiifcado?.\n//     const stringkeys = [\n//         {key: 'emitcertificate_title', component: 'mod_certifygen'},\n//         {key: 'emitcertificate_body', component: 'mod_certifygen', param: langstring},\n//         {key: 'confirm', component: 'mod_certifygen'},\n//         {key: 'emitcertificate_error', component: 'mod_certifygen'}\n//     ];\n//     let langStrings = await getStrings(stringkeys);\n//\n//     let modal = await ModalFactory.create({\n//         title: langStrings[0],\n//         body: langStrings[1],\n//         type: ModalFactory.types.SAVE_CANCEL\n//     });\n//     modal.setSaveButtonText(langStrings[2]);\n//     modal.getRoot().on(ModalEvents.save, () => {\n//         let request = {\n//             methodname: SERVICES.EMIT_CERTIFICATE,\n//             args: {\n//                 id,\n//                 modelid,\n//                 lang,\n//                 userid,\n//                 courseid,\n//             }\n//         };\n//         modal.destroy();\n//         Ajax.call([request])[0].done(function(response) {\n//             if (response.result === true) {\n//                 studentsReloadTable(modelid, courseid, cmid, lang);\n//             } else {\n//                 Notification.alert('Error', response.message, langStrings[2]);\n//             }\n//         }).fail(Notification.exception);\n//     });\n//     modal.getRoot().on(ModalEvents.hidden, () => {\n//         modal.destroy();\n//     });\n//     modal.show();\n// };\n// const teacherReloadTable = (modelid, courseid, cmid) => {\n//     modelid = parseInt(modelid);\n//     courseid = parseInt(courseid);\n//     cmid = parseInt(cmid);\n//     Templates.render(TEMPLATES.LOADING, {visible: true}).done(function(html) {\n//         let identifier = jQuery(REGION.ROOT);\n//         identifier.append(html);\n//         let request = {\n//             methodname: SERVICES.MYSTUDENTS_TABLE_DATA,\n//             args: {modelid, courseid, cmid}\n//         };\n//         Ajax.call([request])[0].done(function(data) {\n//             Templates.render(TEMPLATES.TEACHER_TABLE, data).then((html, js) => {\n//                 identifier.html(html);\n//                 Templates.runTemplateJS(js);\n//             }).fail(Notification.exception);\n//         }).fail((error) => {\n//             Notification.alert('Error', error.message, 'cancel');\n//         });\n//     });\n// };\n// const studentsReloadTable = (modelid, courseid, cmid, lang) => {\n//     modelid = parseInt(modelid);\n//     courseid = parseInt(courseid);\n//     cmid = parseInt(cmid);\n//     Templates.render(TEMPLATES.LOADING, {visible: true}).done(function(html) {\n//         let identifier = jQuery(REGION.ROOT);\n//         identifier.append(html);\n//         let request = {\n//             methodname: SERVICES.GET_MYCERTIFICATE_TABLE_DATA,\n//             args: {modelid, courseid, cmid, lang}\n//         };\n//         Ajax.call([request])[0].done(function(data) {\n//             Templates.render(TEMPLATES.STUDENTS_TABLE, data).then(function(html, js) {\n//                 identifier.html(html);\n//                 Templates.runTemplateJS(js);\n//             }).fail(Notification.exception);\n//         }).fail((error) => {\n//             Notification.alert('Error', error.message, 'cancel');\n//         });\n//     });\n// };\nexport const init = () => {\n    requestManagement();\n};"],"names":["REGION","TEMPLATES","ACTION","SERVICES","emitCertificate","async","id","event","currentTarget","getAttribute","parseInt","userid","stringkeys","key","component","param","then","langStrings","ModalFactory","create","title","body","type","types","SAVE_CANCEL","modal","getRoot","on","ModalEvents","hidden","destroy","save","request","methodname","args","call","done","response","result","message","CANCEL","reloadTeacherRequestTable","fail","Notification","exception","show","seeCourses","coursesids","coursesdata","Ajax","courseshtml","Templates","render","html","DEFAULT","deleteRequest","parent","remove","createRequest","e","preventDefault","element","target","modalForm","ModalForm","formClass","modalConfig","returnFocus","addEventListener","events","FORM_SUBMITTED","setTimeout","visible","identifier","append","data","js","runTemplateJS"],"mappings":"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"}