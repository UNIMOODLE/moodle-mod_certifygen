{"version":3,"file":"requestmanagement.min.js","sources":["../src/requestmanagement.js"],"sourcesContent":["/**\n * @module    mod_certifygen\n * @copyright  2024 Proyecto UNIMOODLE\n * @author     UNIMOODLE Group (Coordinator) <direccion.area.estrategia.digital@uva.es>\n * @author     3IPUNT <contacte@tresipunt.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\"use strict\";\n\nimport jQuery from 'jquery';\nimport {get_string as getString, get_strings as getStrings} from 'core/str';\nimport Ajax from 'core/ajax';\nimport Templates from 'core/templates';\nimport ModalFactory from 'core/modal_factory';\nimport ModalEvents from 'core/modal_events';\nimport Notification from 'core/notification';\nimport ModalForm from 'core_form/modalform';\n\nlet REGION = {\n    ROOT: '[data-region=\"profile-my-certificates\"]',\n};\nlet TEMPLATES = {\n    LOADING: 'core/overlay_loading',\n    TEACHER_REQUEST: 'mod_certifygen/profile_my_certificates',\n    COURSE_LIST_REQUEST: 'mod_certifygen/course_list_request',\n};\nlet ACTION = {\n    CREATE_REQUEST: '[data-action=\"create-request\"]',\n    DELETE_REQUEST: '[data-action=\"delete-request\"]',\n    SEE_COURSES: '[data-action=\"see-courses\"]',\n    EMIT: '[data-action=\"emit\"]',\n    DOWNLOAD: '[data-action=\"download-certificate\"]',\n};\nlet SERVICES = {\n    GET_TEACHER_REQUEST_VIEW_DATA: 'mod_certifygen_getteacherrequestviewdata',\n    DELETE_TEACHER_REQUEST: 'mod_certifygen_deleteteacherrequest',\n    GET_COURSES_NAMES: 'mod_certifygen_getcoursesnames',\n    EMIT_TEACHER_REQUEST: 'mod_certifygen_emitteacherrequest',\n    DOWNLOAD_TEACHER_CERTIFICATE: 'mod_certifygen_downloadteachercertificate',\n};\nconst requestManagement = () => {\n    jQuery(ACTION.CREATE_REQUEST).on('click', createRequest);\n    jQuery(ACTION.DELETE_REQUEST).on('click', deleteRequest);\n    jQuery(ACTION.SEE_COURSES).on('click', seeCourses);\n    jQuery(ACTION.EMIT).on('click', emitCertificate);\n    jQuery(ACTION.DOWNLOAD).on('click', downloadCertificate);\n};\n\nconst downloadCertificate = async(event) => {\n    let id = parseInt(event.currentTarget.getAttribute('data-id'));\n    let name = event.currentTarget.getAttribute('data-name');\n\n    // Modal estas seguro que quieres enviar el certiifcado?.\n    const stringkeys = [\n        {key: 'downloadcertificate_title', component: 'mod_certifygen'},\n        {key: 'downloadcertificate_body', component: 'mod_certifygen', param: name},\n        {key: 'confirm', component: 'mod_certifygen'},\n        {key: 'downloadcertificate_error', component: 'mod_certifygen'}\n    ];\n    let langStrings = await getStrings(stringkeys);\n\n    let modal = await ModalFactory.create({\n        title: langStrings[0],\n        body: langStrings[1],\n        type: ModalFactory.types.SAVE_CANCEL\n    });\n    modal.setSaveButtonText(langStrings[2]);\n    modal.getRoot().on(ModalEvents.save, () => {\n        let request = {\n            methodname: SERVICES.DOWNLOAD_TEACHER_CERTIFICATE,\n            args: {\n                id\n            }\n        };\n        modal.destroy();\n        Ajax.call([request])[0].done(function(response) {\n            if (response.result === true) {\n                window.open(response.url, \"_blank\");\n            } else {\n                Notification.alert('Error', response.message, langStrings[2]);\n            }\n        }).fail(Notification.exception);\n    });\n    modal.getRoot().on(ModalEvents.hidden, () => {\n        modal.destroy();\n    });\n    modal.show();\n};\nconst emitCertificate = async (event) => {\n    let id = event.currentTarget.getAttribute('data-id');\n    id = parseInt(id);\n    let userid = event.currentTarget.getAttribute('data-userid');\n    const stringkeys = [\n        {key: 'emitrequesttitle', component: 'mod_certifygen'},\n        {key: 'emitrequestbody', component: 'mod_certifygen', param: id},\n        {key: 'confirm', component: 'mod_certifygen'},\n        {key: 'errortitle', component: 'mod_certifygen'},\n    ];\n    getStrings(stringkeys).then((langStrings) => {\n        return ModalFactory.create({\n            title: langStrings[0],\n            body: langStrings[1],\n            type: ModalFactory.types.SAVE_CANCEL\n        }).then(modal => {\n            modal.getRoot().on(ModalEvents.hidden, () => {\n                modal.destroy();\n            });\n            modal.getRoot().on(ModalEvents.save, () => {\n                let request = {\n                    methodname: SERVICES.EMIT_TEACHER_REQUEST,\n                    args: {id}\n                };\n                Ajax.call([request])[0].done(function(response) {\n                    if (response.result == 1) {\n                        // Recargar tabla.\n                        reloadTeacherRequestTable(userid);\n                    } else {\n                        // Mostrar mensaje error.\n                        return ModalFactory.create({\n                            title: langStrings[0],\n                            body: response.message,\n                            type: ModalFactory.types.CANCEL\n                        }).then(modal => {\n                            modal.getRoot().on(ModalEvents.hidden, () => {\n                                modal.destroy();\n                            });\n                        });\n                    }\n                }).fail(Notification.exception);\n            });\n            return modal;\n        });\n    }).done(function(modal) {\n        modal.show();\n    }).fail(Notification.exception);\n};\nconst seeCourses = async (event) => {\n    let name = event.currentTarget.getAttribute('data-name');\n    let coursesids = event.currentTarget.getAttribute('data-courses');\n    const stringkeys = [\n        {key: 'seecoursestitle', component: 'mod_certifygen', param: name},\n    ];\n    let langStrings = await getStrings(stringkeys);\n    let request = {\n        methodname: SERVICES.GET_COURSES_NAMES,\n        args: {coursesids}\n    };\n    let coursesdata = await Ajax.call([request])[0];\n    let courseshtml = await Templates.render(TEMPLATES.COURSE_LIST_REQUEST, coursesdata).done(function(html) {\n        return html;\n    });\n    await ModalFactory.create({\n            title: langStrings[0],\n            body: courseshtml,\n            type: ModalFactory.types.DEFAULT,\n        }).then(modal => {\n            modal.show();\n            modal.getRoot().on(ModalEvents.hidden, () => {\n                modal.destroy();\n            });\n        });\n};\nconst deleteRequest = (event) => {\n    let id = event.currentTarget.getAttribute('data-id');\n    const stringkeys = [\n        {key: 'deleterequesttitle', component: 'mod_certifygen'},\n        {key: 'deleterequestbody', component: 'mod_certifygen', param: id},\n        {key: 'confirm', component: 'mod_certifygen'},\n        {key: 'errortitle', component: 'mod_certifygen'},\n    ];\n    getStrings(stringkeys).then((langStrings) => {\n        return ModalFactory.create({\n            title: langStrings[0],\n            body: langStrings[1],\n            type: ModalFactory.types.SAVE_CANCEL\n        }).then(modal => {\n            modal.getRoot().on(ModalEvents.hidden, () => {\n                modal.destroy();\n            });\n            modal.getRoot().on(ModalEvents.save, () => {\n                let request = {\n                    methodname: SERVICES.DELETE_TEACHER_REQUEST,\n                    args: { id}\n                };\n                Ajax.call([request])[0].done(function(response) {\n                    if (response.result == 1) {\n                        // Remove tr.\n                        jQuery(event.currentTarget).parent().parent().remove();\n                    } else {\n                        // Mostrar mensaje error.\n                        return ModalFactory.create({\n                            title: langStrings[0],\n                            body: response.message,\n                            type: ModalFactory.types.CANCEL\n                        }).then(modal => {\n                            modal.getRoot().on(ModalEvents.hidden, () => {\n                                modal.destroy();\n                            });\n                        });\n                    }\n                }).fail(Notification.exception);\n            });\n            return modal;\n        });\n    }).done(function(modal) {\n        modal.show();\n    }).fail(Notification.exception);\n};\nconst createRequest = (e) => {\n    e.preventDefault();\n    const element = e.target;\n    let id = event.currentTarget.getAttribute('data-id');\n    let userid = event.currentTarget.getAttribute('data-userid');\n\n    const modalForm = new ModalForm({\n        // Name of the class where form is defined (must extend \\core_form\\dynamic_form):\n        formClass: \"mod_certifygen\\\\forms\\\\teacherrequestform\",\n        // Add as many arguments as you need, they will be passed to the form:\n        args: {id, userid},\n        // Pass any configuration settings to the modal dialogue, for example, the title:\n        modalConfig: {title: getString('create_request', 'mod_certifygen')},\n        // DOM element that should get the focus after the modal dialogue is closed:\n        returnFocus: element,\n    });\n    // Listen to events if you want to execute something on form submit. Event detail will contain everything the process()\n    // function returned:\n    modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, () => {\n        // Recargar la tabla.\n        setTimeout(reloadTeacherRequestTable(userid), 1000);\n\n    });\n    // Show the form.\n    modalForm.show();\n};\nconst reloadTeacherRequestTable = (userid) => {\n    Templates.render(TEMPLATES.LOADING, {visible: true}).done(function(html) {\n        let identifier = jQuery(REGION.ROOT);\n        identifier.append(html);\n        let request = {\n            methodname: SERVICES.GET_TEACHER_REQUEST_VIEW_DATA,\n            args: {userid}\n        };\n        Ajax.call([request])[0].done(function(data) {\n            Templates.render(TEMPLATES.TEACHER_REQUEST, data).then((html, js) => {\n                identifier.html(html);\n                Templates.runTemplateJS(js);\n            }).fail(Notification.exception);\n        }).fail(Notification.exception);\n    });\n};\n\nexport const init = () => {\n    requestManagement();\n};"],"names":["REGION","TEMPLATES","ACTION","SERVICES","downloadCertificate","async","id","parseInt","event","currentTarget","getAttribute","stringkeys","key","component","param","langStrings","modal","ModalFactory","create","title","body","type","types","SAVE_CANCEL","setSaveButtonText","getRoot","on","ModalEvents","save","request","methodname","args","destroy","call","done","response","result","window","open","url","alert","message","fail","Notification","exception","hidden","show","emitCertificate","userid","then","CANCEL","reloadTeacherRequestTable","seeCourses","name","coursesids","coursesdata","Ajax","courseshtml","Templates","render","html","DEFAULT","deleteRequest","parent","remove","createRequest","e","preventDefault","element","target","modalForm","ModalForm","formClass","modalConfig","returnFocus","addEventListener","events","FORM_SUBMITTED","setTimeout","visible","identifier","append","data","js","runTemplateJS"],"mappings":"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"}