define("mod_certifygen/activitymanager",["exports","jquery","core/str","core/ajax","core/templates","core/modal_factory","core/modal_events","core/notification"],(function(_exports,_jquery,_str,_ajax,_templates,_modal_factory,_modal_events,_notification){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_jquery=_interopRequireDefault(_jquery),_ajax=_interopRequireDefault(_ajax),_templates=_interopRequireDefault(_templates),_modal_factory=_interopRequireDefault(_modal_factory),_modal_events=_interopRequireDefault(_modal_events),_notification=_interopRequireDefault(_notification);let TEMPLATES_LOADING="core/overlay_loading",TEMPLATES_ACTIVITY_TABLE="mod_certifygen/activity",ACTION_EMIT_CERTIFICATE='[data-action="emit-certificate"]',ACTION_REEMIT_CERTIFICATE='[data-action="reemit-certificate"]',ACTION_REVOKE_CERTIFICATE='[data-action="revoke-certificate"]',ACTION_DOWNLOAD_CERTIFICATE='[data-action="download-certificate"]',SERVICES_EMIT_CERTIFICATE="mod_certifygen_emitcertificate",SERVICES_REEMIT_CERTIFICATE="mod_certifygen_reemitcertificate",SERVICES_GET_MYCERTIFICATE_TABLE_DATA="mod_certifygen_getmycertificatedata",SERVICES_REVOKE_CERTIFICATE="mod_certifygen_revokecertificate",SERVICES_DOWNLOAD_CERTIFICATE="mod_certifygen_downloadcertificate";const reemitCertificate=async event=>{let id=event.currentTarget.getAttribute("data-id"),modelid=parseInt(event.currentTarget.getAttribute("data-modelid")),lang=event.currentTarget.getAttribute("data-lang"),courseid=parseInt(event.currentTarget.getAttribute("data-courseid")),cmid=parseInt(event.currentTarget.getAttribute("data-cmid"));id=parseInt(id),modelid=parseInt(modelid),courseid=parseInt(courseid),cmid=parseInt(cmid);const stringkeys=[{key:"emitrequesttitle",component:"mod_certifygen"},{key:"emitrequestbody",component:"mod_certifygen",param:id},{key:"confirm",component:"mod_certifygen"},{key:"errortitle",component:"mod_certifygen"}];_templates.default.render(TEMPLATES_LOADING,{visible:!0}).done((function(html){let identifier=(0,_jquery.default)('[data-region="mainpage"]');identifier.append(html),(0,_str.get_strings)(stringkeys).then((langStrings=>_modal_factory.default.create({title:langStrings[0],body:langStrings[1],type:_modal_factory.default.types.SAVE_CANCEL}).then((modal=>(modal.getRoot().on(_modal_events.default.hidden,(()=>{identifier.find(".overlay-icon-container").remove(),modal.destroy()})),modal.getRoot().on(_modal_events.default.cancel,(()=>{identifier.find(".overlay-icon-container").remove(),studentsReloadTable(modelid,courseid,cmid,lang)})),modal.getRoot().on(_modal_events.default.save,(()=>{let request={methodname:SERVICES_REEMIT_CERTIFICATE,args:{id:id}};_ajax.default.call([request])[0].done((function(response){if(identifier.html(html),1!=response.result)return _modal_factory.default.create({title:langStrings[3],body:response.message,type:_modal_factory.default.types.CANCEL}).then((modal=>{modal.getRoot().on(_modal_events.default.hidden,(()=>{identifier.find(".overlay-icon-container").remove(),studentsReloadTable(modelid,courseid,cmid,lang),modal.destroy()})),modal.show()}));studentsReloadTable(modelid,courseid,cmid,lang)})).fail(_notification.default.exception)})),modal))))).done((function(modal){modal.show()})).fail(_notification.default.exception)}))},downloadCertificate=async event=>{let modelid=parseInt(event.currentTarget.getAttribute("data-modelid")),code=event.currentTarget.getAttribute("data-code"),langstring=event.currentTarget.getAttribute("data-langstring"),id=parseInt(event.currentTarget.getAttribute("data-id")),instanceid=parseInt(event.currentTarget.getAttribute("data-instanceid")),courseid=parseInt(event.currentTarget.getAttribute("data-courseid"));const stringkeys=[{key:"downloadcertificate_title",component:"mod_certifygen"},{key:"downloadcertificate_body",component:"mod_certifygen",param:langstring},{key:"confirm",component:"mod_certifygen"},{key:"downloadcertificate_error",component:"mod_certifygen"}];let langStrings=await(0,_str.get_strings)(stringkeys),modal=await _modal_factory.default.create({title:langStrings[0],body:langStrings[1],type:_modal_factory.default.types.SAVE_CANCEL});modal.setSaveButtonText(langStrings[2]),modal.getRoot().on(_modal_events.default.save,(()=>{let request={methodname:SERVICES_DOWNLOAD_CERTIFICATE,args:{id:id,instanceid:instanceid,modelid:modelid,code:code,courseid:courseid}};modal.destroy(),_ajax.default.call([request])[0].done((function(response){!0===response.result?((0,_jquery.default)(event.currentTarget).parent().parent().find(".code").html(response.codetag),window.open(response.url,"_blank")):_notification.default.alert("Error",response.message,langStrings[2])})).fail(_notification.default.exception)})),modal.getRoot().on(_modal_events.default.hidden,(()=>{modal.destroy()})),modal.show()},revokeCertificate=async event=>{let issueid=event.currentTarget.getAttribute("data-issueid"),cmid=event.currentTarget.getAttribute("data-cmid"),userid=event.currentTarget.getAttribute("data-userid"),modelid=event.currentTarget.getAttribute("data-modelid"),courseid=event.currentTarget.getAttribute("data-courseid"),username=event.currentTarget.getAttribute("data-username"),lang=event.currentTarget.getAttribute("data-lang");const stringkeys=[{key:"revokecertificate_title",component:"mod_certifygen"},{key:"revokecertificate_body",component:"mod_certifygen",param:username},{key:"confirm",component:"mod_certifygen"},{key:"revokecertificate_error",component:"mod_certifygen"}];let langStrings=await(0,_str.get_strings)(stringkeys),modal=await _modal_factory.default.create({title:langStrings[0],body:langStrings[1],type:_modal_factory.default.types.SAVE_CANCEL});modal.setSaveButtonText(langStrings[2]),modal.getRoot().on(_modal_events.default.save,(()=>{let request={methodname:SERVICES_REVOKE_CERTIFICATE,args:{issueid:issueid,userid:userid,modelid:modelid}};modal.destroy(),_ajax.default.call([request])[0].done((function(response){!0===response.result?studentsReloadTable(modelid,courseid,cmid,lang):_notification.default.alert("Error",response.message,langStrings[2])})).fail(_notification.default.exception)})),modal.getRoot().on(_modal_events.default.hidden,(()=>{modal.destroy()})),modal.show()},emitCertificate=async event=>{let id=parseInt(event.currentTarget.getAttribute("data-id")),modelid=parseInt(event.currentTarget.getAttribute("data-modelid")),lang=event.currentTarget.getAttribute("data-lang"),langstring=event.currentTarget.getAttribute("data-langstring"),userid=parseInt(event.currentTarget.getAttribute("data-userid")),courseid=parseInt(event.currentTarget.getAttribute("data-courseid")),cmid=parseInt(event.currentTarget.getAttribute("data-cmid")),instanceid=parseInt(event.currentTarget.getAttribute("data-instanceid")),identifier=(0,_jquery.default)('[data-region="mainpage"]');const stringkeys=[{key:"emitcertificate_title",component:"mod_certifygen"},{key:"emitcertificate_body",component:"mod_certifygen",param:langstring},{key:"confirm",component:"mod_certifygen"},{key:"emitcertificate_error",component:"mod_certifygen"}];_templates.default.render(TEMPLATES_LOADING,{visible:!0}).done((async function(html){identifier.append(html),identifier.find(".overlay-icon-container").css("position","fixed");let langStrings=await(0,_str.get_strings)(stringkeys),modal=await _modal_factory.default.create({title:langStrings[0],body:langStrings[1],type:_modal_factory.default.types.SAVE_CANCEL}),waitingforrequest=!1;modal.setSaveButtonText(langStrings[2]),modal.getRoot().on(_modal_events.default.save,(()=>{waitingforrequest=!0;let request={methodname:SERVICES_EMIT_CERTIFICATE,args:{id:id,instanceid:instanceid,modelid:modelid,lang:lang,userid:userid,courseid:courseid}};_ajax.default.call([request])[0].done((function(response){waitingforrequest=!1,modal.destroy(),!0===response.result||_notification.default.alert("Error",response.message,langStrings[2]),studentsReloadTable(modelid,courseid,cmid,lang),identifier.find(".overlay-icon-container").remove()})).fail(_notification.default.exception)})),modal.getRoot().on(_modal_events.default.hidden,(()=>{waitingforrequest||(identifier.find(".overlay-icon-container").remove(),modal.destroy())})),modal.getRoot().on(_modal_events.default.cancel,(()=>{waitingforrequest||identifier.find(".overlay-icon-container").remove()})),modal.show()}))},studentsReloadTable=(modelid,courseid,cmid,lang)=>{modelid=parseInt(modelid),courseid=parseInt(courseid),cmid=parseInt(cmid),_templates.default.render(TEMPLATES_LOADING,{visible:!0}).done((function(html){let identifier=(0,_jquery.default)('[data-region="mainpage"]');identifier.append(html),identifier.find(".overlay-icon-container").css("position","fixed");let request={methodname:SERVICES_GET_MYCERTIFICATE_TABLE_DATA,args:{modelid:modelid,courseid:courseid,cmid:cmid,lang:lang}};_ajax.default.call([request])[0].done((function(data){_templates.default.render(TEMPLATES_ACTIVITY_TABLE,data).then((function(html,js){(0,_jquery.default)('[data-region="activity-view"]').replaceWith(html),_templates.default.runTemplateJS(js),identifier.find(".overlay-icon-container").remove()})).fail(_notification.default.exception)})).fail((error=>{identifier.find(".overlay-icon-container").remove(),_notification.default.alert("Error",error.message,"cancel")}))}))};_exports.init=()=>{(0,_jquery.default)(ACTION_EMIT_CERTIFICATE).on("click",emitCertificate),(0,_jquery.default)(ACTION_REEMIT_CERTIFICATE).on("click",reemitCertificate),(0,_jquery.default)(ACTION_REVOKE_CERTIFICATE).on("click",revokeCertificate),(0,_jquery.default)(ACTION_DOWNLOAD_CERTIFICATE).on("click",downloadCertificate)}}));

//# sourceMappingURL=activitymanager.min.js.map