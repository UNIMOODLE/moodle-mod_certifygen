{"version":3,"file":"certificatemanager.min.js","sources":["../src/certificatemanager.js"],"sourcesContent":["/**\n * @module    mod_certifygen\n * @copyright  2024 Proyecto UNIMOODLE\n * @author     UNIMOODLE Group (Coordinator) <direccion.area.estrategia.digital@uva.es>\n * @author     3IPUNT <contacte@tresipunt.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\"use strict\";\n\nimport jQuery from 'jquery';\nimport {get_strings as getStrings} from 'core/str';\nimport Ajax from 'core/ajax';\nimport Templates from 'core/templates';\nimport ModalFactory from 'core/modal_factory';\nimport ModalEvents from 'core/modal_events';\nimport Notification from 'core/notification';\n\nlet REGION = {\n    ROOT: '[data-region=\"activity-view\"]',\n};\nlet TEMPLATES = {\n    LOADING: 'core/overlay_loading',\n    ACTIVITY_TABLE: 'mod_certifygen/activity',\n};\nlet ACTION = {\n    EMIT_CERTIFICATE: '[data-action=\"emit-certificate\"]',\n    REVOKE_CERTIFICATE: '[data-action=\"revoke-certificate\"]',\n    DOWNLOAD_CERTIFICATE: '[data-action=\"download-certificate\"]',\n};\nlet SERVICES = {\n    EMIT_CERTIFICATE: 'mod_certifygen_emitcertificate',\n    // MYSTUDENTS_TABLE_DATA: 'mod_certifygen_get_students_certificates_table',\n    GET_MYCERTIFICATE_TABLE_DATA: 'mod_certifygen_getmycertificatedata',\n    REVOKE_CERTIFICATE: 'mod_certifygen_revokecertificate',\n    DOWNLOAD_CERTIFICATE: 'mod_certifygen_downloadcertificate',\n};\nconst certificateManagement = () => {\n    jQuery(ACTION.EMIT_CERTIFICATE).on('click', emitCertificate);\n    jQuery(ACTION.REVOKE_CERTIFICATE).on('click', revokeCertificate);\n    jQuery(ACTION.DOWNLOAD_CERTIFICATE).on('click', downloadCertificate);\n};\n\nconst downloadCertificate = async(event) => {\n    let modelid = parseInt(event.currentTarget.getAttribute('data-modelid'));\n    let code = event.currentTarget.getAttribute('data-code');\n    // let lang = event.currentTarget.getAttribute('data-lang');\n    let langstring = event.currentTarget.getAttribute('data-langstring');\n    // let userid = parseInt(event.currentTarget.getAttribute('data-userid'));\n    let id = parseInt(event.currentTarget.getAttribute('data-id'));\n    let courseid = parseInt(event.currentTarget.getAttribute('data-courseid'));\n    // let cmid = parseInt(event.currentTarget.getAttribute('data-cmid'));\n\n    // Modal estas seguro que quieres enviar el certiifcado?.\n    const stringkeys = [\n        {key: 'downloadcertificate_title', component: 'mod_certifygen'},\n        {key: 'downloadcertificate_body', component: 'mod_certifygen', param: langstring},\n        {key: 'confirm', component: 'mod_certifygen'},\n        {key: 'downloadcertificate_error', component: 'mod_certifygen'}\n    ];\n    let langStrings = await getStrings(stringkeys);\n\n    let modal = await ModalFactory.create({\n        title: langStrings[0],\n        body: langStrings[1],\n        type: ModalFactory.types.SAVE_CANCEL\n    });\n    modal.setSaveButtonText(langStrings[2]);\n    modal.getRoot().on(ModalEvents.save, () => {\n        let request = {\n            methodname: SERVICES.DOWNLOAD_CERTIFICATE,\n            args: {\n                id,\n                modelid,\n                code,\n                courseid,\n            }\n        };\n        modal.destroy();\n        Ajax.call([request])[0].done(function(response) {\n            if (response.result === true) {\n                jQuery(event.currentTarget).parent().parent().find(\".code\").html(response.codetag);\n                window.open(response.url, \"_blank\");\n            } else {\n                Notification.alert('Error', response.message, langStrings[2]);\n            }\n        }).fail(Notification.exception);\n    });\n    modal.getRoot().on(ModalEvents.hidden, () => {\n        modal.destroy();\n    });\n    modal.show();\n};\nconst revokeCertificate = async(event) => {\n    let issueid = event.currentTarget.getAttribute('data-issueid');\n    let cmid = event.currentTarget.getAttribute('data-cmid');\n    let userid = event.currentTarget.getAttribute('data-userid');\n    let modelid = event.currentTarget.getAttribute('data-modelid');\n    let courseid = event.currentTarget.getAttribute('data-courseid');\n    let username = event.currentTarget.getAttribute('data-username');\n    let lang = event.currentTarget.getAttribute('data-lang');\n    // Modal estas seguro que quieres eliminar el certiifcado?.\n    const stringkeys = [\n        {key: 'revokecertificate_title', component: 'mod_certifygen'},\n        {key: 'revokecertificate_body', component: 'mod_certifygen', param: username},\n        {key: 'confirm', component: 'mod_certifygen'},\n        {key: 'revokecertificate_error', component: 'mod_certifygen'}\n    ];\n    let langStrings = await getStrings(stringkeys);\n\n    let modal = await ModalFactory.create({\n        title: langStrings[0],\n        body: langStrings[1],\n        type: ModalFactory.types.SAVE_CANCEL\n    });\n    modal.setSaveButtonText(langStrings[2]);\n    modal.getRoot().on(ModalEvents.save, () => {\n        let request = {\n            methodname: SERVICES.REVOKE_CERTIFICATE,\n            args: {\n                issueid,\n                userid,\n                modelid,\n            }\n        };\n        modal.destroy();\n        Ajax.call([request])[0].done(function(response) {\n            if (response.result === true) {\n                studentsReloadTable(modelid, courseid, cmid, lang);\n            } else {\n                Notification.alert('Error', response.message, langStrings[2]);\n            }\n        }).fail(Notification.exception);\n    });\n    modal.getRoot().on(ModalEvents.hidden, () => {\n        modal.destroy();\n    });\n    modal.show();\n};\nconst emitCertificate = async(event) => {\n    let id = parseInt(event.currentTarget.getAttribute('data-id'));\n    let modelid = parseInt(event.currentTarget.getAttribute('data-modelid'));\n    let lang = event.currentTarget.getAttribute('data-lang');\n    let langstring = event.currentTarget.getAttribute('data-langstring');\n    let userid = parseInt(event.currentTarget.getAttribute('data-userid'));\n    let courseid = parseInt(event.currentTarget.getAttribute('data-courseid'));\n    let cmid = parseInt(event.currentTarget.getAttribute('data-cmid'));\n\n    // Modal estas seguro que quieres enviar el certiifcado?.\n    const stringkeys = [\n        {key: 'emitcertificate_title', component: 'mod_certifygen'},\n        {key: 'emitcertificate_body', component: 'mod_certifygen', param: langstring},\n        {key: 'confirm', component: 'mod_certifygen'},\n        {key: 'emitcertificate_error', component: 'mod_certifygen'}\n    ];\n    let langStrings = await getStrings(stringkeys);\n\n    let modal = await ModalFactory.create({\n        title: langStrings[0],\n        body: langStrings[1],\n        type: ModalFactory.types.SAVE_CANCEL\n    });\n    modal.setSaveButtonText(langStrings[2]);\n    modal.getRoot().on(ModalEvents.save, () => {\n        let request = {\n            methodname: SERVICES.EMIT_CERTIFICATE,\n            args: {\n                id,\n                modelid,\n                lang,\n                userid,\n                courseid,\n            }\n        };\n        modal.destroy();\n        Ajax.call([request])[0].done(function(response) {\n            if (response.result === true) {\n                studentsReloadTable(modelid, courseid, cmid, lang);\n            } else {\n                Notification.alert('Error', response.message, langStrings[2]);\n            }\n        }).fail(Notification.exception);\n    });\n    modal.getRoot().on(ModalEvents.hidden, () => {\n        modal.destroy();\n    });\n    modal.show();\n};\nconst studentsReloadTable = (modelid, courseid, cmid, lang) => {\n    modelid = parseInt(modelid);\n    courseid = parseInt(courseid);\n    cmid = parseInt(cmid);\n    Templates.render(TEMPLATES.LOADING, {visible: true}).done(function(html) {\n        let identifier = jQuery(REGION.ROOT);\n        identifier.append(html);\n        let request = {\n            methodname: SERVICES.GET_MYCERTIFICATE_TABLE_DATA,\n            args: {modelid, courseid, cmid, lang}\n        };\n        Ajax.call([request])[0].done(function(data) {\n            Templates.render(TEMPLATES.ACTIVITY_TABLE, data).then(function(html, js) {\n                identifier.html(html);\n                Templates.runTemplateJS(js);\n            }).fail(Notification.exception);\n        }).fail((error) => {\n            Notification.alert('Error', error.message, 'cancel');\n        });\n    });\n};\nexport const init = () => {\n    certificateManagement();\n};"],"names":["REGION","TEMPLATES","ACTION","SERVICES","downloadCertificate","async","modelid","parseInt","event","currentTarget","getAttribute","code","langstring","id","courseid","stringkeys","key","component","param","langStrings","modal","ModalFactory","create","title","body","type","types","SAVE_CANCEL","setSaveButtonText","getRoot","on","ModalEvents","save","request","methodname","args","destroy","call","done","response","result","parent","find","html","codetag","window","open","url","alert","message","fail","Notification","exception","hidden","show","revokeCertificate","issueid","cmid","userid","username","lang","studentsReloadTable","emitCertificate","render","visible","identifier","append","data","then","js","runTemplateJS","error"],"mappings":"6rBAiBIA,YACM,gCAENC,kBACS,uBADTA,yBAEgB,0BAEhBC,wBACkB,mCADlBA,0BAEoB,qCAFpBA,4BAGsB,uCAEtBC,0BACkB,iCADlBA,sCAG8B,sCAH9BA,4BAIoB,mCAJpBA,8BAKsB,2CAQpBC,oBAAsBC,MAAAA,YACpBC,QAAUC,SAASC,MAAMC,cAAcC,aAAa,iBACpDC,KAAOH,MAAMC,cAAcC,aAAa,aAExCE,WAAaJ,MAAMC,cAAcC,aAAa,mBAE9CG,GAAKN,SAASC,MAAMC,cAAcC,aAAa,YAC/CI,SAAWP,SAASC,MAAMC,cAAcC,aAAa,wBAInDK,WAAa,CACf,CAACC,IAAK,4BAA6BC,UAAW,kBAC9C,CAACD,IAAK,2BAA4BC,UAAW,iBAAkBC,MAAON,YACtE,CAACI,IAAK,UAAWC,UAAW,kBAC5B,CAACD,IAAK,4BAA6BC,UAAW,uBAE9CE,kBAAoB,oBAAWJ,YAE/BK,YAAcC,uBAAaC,OAAO,CAClCC,MAAOJ,YAAY,GACnBK,KAAML,YAAY,GAClBM,KAAMJ,uBAAaK,MAAMC,cAE7BP,MAAMQ,kBAAkBT,YAAY,IACpCC,MAAMS,UAAUC,GAAGC,sBAAYC,MAAM,SAC7BC,QAAU,CACVC,WAAY/B,8BACZgC,KAAM,CACFtB,GAAAA,GACAP,QAAAA,QACAK,KAAAA,KACAG,SAAAA,WAGRM,MAAMgB,wBACDC,KAAK,CAACJ,UAAU,GAAGK,MAAK,SAASC,WACV,IAApBA,SAASC,4BACFhC,MAAMC,eAAegC,SAASA,SAASC,KAAK,SAASC,KAAKJ,SAASK,SAC1EC,OAAOC,KAAKP,SAASQ,IAAK,iCAEbC,MAAM,QAAST,SAASU,QAAS9B,YAAY,OAE/D+B,KAAKC,sBAAaC,cAEzBhC,MAAMS,UAAUC,GAAGC,sBAAYsB,QAAQ,KACnCjC,MAAMgB,aAEVhB,MAAMkC,QAEJC,kBAAoBlD,MAAAA,YAClBmD,QAAUhD,MAAMC,cAAcC,aAAa,gBAC3C+C,KAAOjD,MAAMC,cAAcC,aAAa,aACxCgD,OAASlD,MAAMC,cAAcC,aAAa,eAC1CJ,QAAUE,MAAMC,cAAcC,aAAa,gBAC3CI,SAAWN,MAAMC,cAAcC,aAAa,iBAC5CiD,SAAWnD,MAAMC,cAAcC,aAAa,iBAC5CkD,KAAOpD,MAAMC,cAAcC,aAAa,mBAEtCK,WAAa,CACf,CAACC,IAAK,0BAA2BC,UAAW,kBAC5C,CAACD,IAAK,yBAA0BC,UAAW,iBAAkBC,MAAOyC,UACpE,CAAC3C,IAAK,UAAWC,UAAW,kBAC5B,CAACD,IAAK,0BAA2BC,UAAW,uBAE5CE,kBAAoB,oBAAWJ,YAE/BK,YAAcC,uBAAaC,OAAO,CAClCC,MAAOJ,YAAY,GACnBK,KAAML,YAAY,GAClBM,KAAMJ,uBAAaK,MAAMC,cAE7BP,MAAMQ,kBAAkBT,YAAY,IACpCC,MAAMS,UAAUC,GAAGC,sBAAYC,MAAM,SAC7BC,QAAU,CACVC,WAAY/B,4BACZgC,KAAM,CACFqB,QAAAA,QACAE,OAAAA,OACApD,QAAAA,UAGRc,MAAMgB,wBACDC,KAAK,CAACJ,UAAU,GAAGK,MAAK,SAASC,WACV,IAApBA,SAASC,OACTqB,oBAAoBvD,QAASQ,SAAU2C,KAAMG,4BAEhCZ,MAAM,QAAST,SAASU,QAAS9B,YAAY,OAE/D+B,KAAKC,sBAAaC,cAEzBhC,MAAMS,UAAUC,GAAGC,sBAAYsB,QAAQ,KACnCjC,MAAMgB,aAEVhB,MAAMkC,QAEJQ,gBAAkBzD,MAAAA,YAChBQ,GAAKN,SAASC,MAAMC,cAAcC,aAAa,YAC/CJ,QAAUC,SAASC,MAAMC,cAAcC,aAAa,iBACpDkD,KAAOpD,MAAMC,cAAcC,aAAa,aACxCE,WAAaJ,MAAMC,cAAcC,aAAa,mBAC9CgD,OAASnD,SAASC,MAAMC,cAAcC,aAAa,gBACnDI,SAAWP,SAASC,MAAMC,cAAcC,aAAa,kBACrD+C,KAAOlD,SAASC,MAAMC,cAAcC,aAAa,oBAG/CK,WAAa,CACf,CAACC,IAAK,wBAAyBC,UAAW,kBAC1C,CAACD,IAAK,uBAAwBC,UAAW,iBAAkBC,MAAON,YAClE,CAACI,IAAK,UAAWC,UAAW,kBAC5B,CAACD,IAAK,wBAAyBC,UAAW,uBAE1CE,kBAAoB,oBAAWJ,YAE/BK,YAAcC,uBAAaC,OAAO,CAClCC,MAAOJ,YAAY,GACnBK,KAAML,YAAY,GAClBM,KAAMJ,uBAAaK,MAAMC,cAE7BP,MAAMQ,kBAAkBT,YAAY,IACpCC,MAAMS,UAAUC,GAAGC,sBAAYC,MAAM,SAC7BC,QAAU,CACVC,WAAY/B,0BACZgC,KAAM,CACFtB,GAAAA,GACAP,QAAAA,QACAsD,KAAAA,KACAF,OAAAA,OACA5C,SAAAA,WAGRM,MAAMgB,wBACDC,KAAK,CAACJ,UAAU,GAAGK,MAAK,SAASC,WACV,IAApBA,SAASC,OACTqB,oBAAoBvD,QAASQ,SAAU2C,KAAMG,4BAEhCZ,MAAM,QAAST,SAASU,QAAS9B,YAAY,OAE/D+B,KAAKC,sBAAaC,cAEzBhC,MAAMS,UAAUC,GAAGC,sBAAYsB,QAAQ,KACnCjC,MAAMgB,aAEVhB,MAAMkC,QAEJO,oBAAsB,CAACvD,QAASQ,SAAU2C,KAAMG,QAClDtD,QAAUC,SAASD,SACnBQ,SAAWP,SAASO,UACpB2C,KAAOlD,SAASkD,yBACNM,OAAO9D,kBAAmB,CAAC+D,SAAS,IAAO1B,MAAK,SAASK,UAC3DsB,YAAa,mBAAOjE,aACxBiE,WAAWC,OAAOvB,UACdV,QAAU,CACVC,WAAY/B,sCACZgC,KAAM,CAAC7B,QAAAA,QAASQ,SAAAA,SAAU2C,KAAAA,KAAMG,KAAAA,qBAE/BvB,KAAK,CAACJ,UAAU,GAAGK,MAAK,SAAS6B,yBACxBJ,OAAO9D,yBAA0BkE,MAAMC,MAAK,SAASzB,KAAM0B,IACjEJ,WAAWtB,KAAKA,yBACN2B,cAAcD,OACzBnB,KAAKC,sBAAaC,cACtBF,MAAMqB,8BACQvB,MAAM,QAASuB,MAAMtB,QAAS,+BAInC,yBA3KT/C,yBAAyB4B,GAAG,QAASgC,qCACrC5D,2BAA2B4B,GAAG,QAASyB,uCACvCrD,6BAA6B4B,GAAG,QAAS1B"}